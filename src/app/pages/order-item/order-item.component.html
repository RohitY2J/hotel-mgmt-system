<app-notification *ngIf="showNotification" [notificationData]="notificationParams"></app-notification>
<app-loader *ngIf="isLoading"></app-loader>

<div id="main-container" class="min-h-screen bg-gray-900 text-gray-100">
    <!-- Header Navigation -->
    <ng-container *ngIf="!isReservationView">
        <header id="main-header" class="bg-gradient-to-r from-gray-800 via-gray-800 to-gray-700 border-b border-gray-600 shadow-2xl">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-utensils text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 id="tenant-name" class="text-2xl font-bold text-white">{{this.userDetails.tenantName}}</h1>
                            <p class="text-gray-400 text-sm">Restaurant Management System</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 text-gray-400">
                            <i class="fas fa-clock text-sm"></i>
                            <span class="text-sm">{{ getCurrentTime() | date: 'HH:mm:ss' }}</span>
                        </div>
                        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-gray-300 text-sm"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </ng-container>

    <div id="content-wrapper" class="max-w-7xl mx-auto p-4 lg:p-6">
        <div class="flex flex-col xl:flex-row gap-6">
            
            <!-- Left Panel - Menu Items -->
            <div id="menu-panel" class="flex-1 bg-gray-800 rounded-xl shadow-xl border border-gray-700">
                
                <!-- Search Section -->
                <div id="search-section" class="p-6 border-b border-gray-700">
                    <div class="flex flex-wrap gap-3">
                        <div class="flex-1 min-w-64">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <app-autocomplete 
                                    id="menu-search"
                                    [placeHolder]="'Search menu items...'" 
                                    [searchControl]="searchControl"
                                    [filteredOptions]="filteredOptions"
                                    (callback)="updateFilterOptions($event)">
                                </app-autocomplete>
                            </div>
                        </div>
                        <button 
                            id="apply-filter-btn"
                            type="button" 
                            (click)="searchButtonClicked()" 
                            class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <span>Apply</span>
                        </button>
                        <button 
                            id="clear-filter-btn"
                            type="button" 
                            (click)="clearFilter()"
                            class="px-4 py-2.5 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200 focus:ring-2 focus:ring-gray-500 focus:outline-none">
                            <span>Clear</span>
                        </button>
                        <button 
                            id="close-btn"
                            *ngIf="this.isReservationView" 
                            type="button" 
                            (click)="onClose.emit()"
                            class="px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-200 focus:ring-2 focus:ring-red-500 focus:outline-none">
                            <span>Close</span>
                        </button>
                    </div>
                </div>

                <!-- Menu Grid -->
                <div id="menu-grid-container" class="p-6">
                    <div id="menu-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 min-h-96">
                        <div 
                            id="menu-item-{{i}}"
                            *ngFor="let menu of allMenus; let i = index" 
                            [attr.role]="isMenuItemClickable() ? 'button' : null"
                            (click)="isMenuItemClickable() ? menuItemSelected(menu) : null"
                            [class]="getMenuItemClasses()">
                            
                            <!-- Disabled Overlay -->
                            <div *ngIf="!isMenuItemClickable()" 
                                 class="absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-10 rounded-lg">
                                <div class="text-center text-gray-400">
                                    <i class="fas fa-lock text-2xl mb-2"></i>
                                    <p class="text-xs font-medium">Select destination & mode</p>
                                </div>
                            </div>
                            
                            <div class="aspect-square overflow-hidden relative">
                                <img 
                                    *ngIf="menu.file" 
                                    [class]="'w-full h-full object-cover transition-transform duration-300 ' + 
                                            (isMenuItemClickable() ? 'group-hover:scale-110' : 'scale-100 grayscale')"
                                    [src]="menu.file" 
                                    [alt]="menu.name">
                                <img 
                                    *ngIf="!menu.file" 
                                    [class]="'w-full h-full object-cover transition-transform duration-300 ' + 
                                            (isMenuItemClickable() ? 'group-hover:scale-110' : 'scale-100 grayscale')"
                                    src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSHXX6GrLiyiN5oDkH8Badn80xAnC5oAumGmchxXoF-b4H9ZDDOJ_iexVov_mSiLU9UCI0&usqp=CAU"
                                    [alt]="menu.name">
                            </div>
                            
                            <div class="p-3 bg-gray-750 relative">
                                <h3 [class]="'font-medium text-sm mb-1 line-clamp-2 ' + 
                                            (isMenuItemClickable() ? 'text-gray-100' : 'text-gray-400')">
                                    {{ menu.name }}
                                </h3>
                                <p [class]="'font-semibold ' + 
                                           (isMenuItemClickable() ? 'text-blue-400' : 'text-gray-500')">
                                    Rs. {{ menu.price }}
                                </p>
                                
                                <!-- Ready indicator -->
                                <div *ngIf="isMenuItemClickable()" 
                                     class="absolute top-2 right-2 w-3 h-3 bg-green-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination-section" class="p-6 border-t border-gray-700">
                    <app-pagination 
                        id="menu-pagination"
                        [dataCount]="filter.pagination.dataCount" 
                        [page]="filter.pagination.page"
                        [pageSize]="filter.pagination.pageSize" 
                        (callback)="updatePaginationPage($event)">
                    </app-pagination>
                </div>
            </div>

            <!-- Right Panel - Order Management -->
            <div id="order-panel" class="w-full xl:w-96 bg-gray-800 rounded-xl shadow-xl border border-gray-700 p-1">
                
                <!-- Header with Status Badge -->
                <div id="order-header" class="p-6 border-b border-gray-700 bg-gradient-to-r from-gray-800 to-gray-750">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-3">
                            <div>
                                <h2 class="text-xl font-bold text-gray-100">Order Management</h2>
                                <p class="text-sm text-gray-400 mt-1">Manage your current orders</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button 
                                id="print-order-btn"
                                [disabled]="isPrintButtonDisabled()" 
                                type="button" 
                                (click)="printOrder()" 
                                class="px-4 py-2.5 bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-all duration-200 focus:ring-2 focus:ring-emerald-500 focus:outline-none flex items-center gap-2 shadow-lg">
                                <i class="fas fa-print text-sm"></i>
                                <span>Print</span>
                            </button>
                            <button 
                                id="submit-order-btn"
                                [disabled]="isSubmitButtonDisabled()" 
                                type="button" 
                                (click)="submitOrder()" 
                                class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:outline-none flex items-center gap-2 shadow-lg">
                                <i class="fas fa-check-circle text-sm"></i>
                                <span>Submit</span>
                            </button>
                        </div>
                    </div>

                    <!-- Order Type Selection -->
                    <ng-container *ngIf="!isReservationView">
                        <div id="order-type-section" class="space-y-4">
                            <!-- Radio Button Section with Better Styling -->
                            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                <h3 class="text-sm font-semibold text-gray-200 mb-3 flex items-center gap-2">
                                    <i class="fas fa-location-dot text-blue-400"></i>
                                    Order Destination
                                </h3>
                                <div class="flex gap-4">
                                    <label class="flex items-center cursor-pointer group">
                                        <div class="relative">
                                            <input 
                                                id="forTable" 
                                                type="radio" 
                                                value="forTable" 
                                                (change)="onRadioChange($event)"
                                                name="default-radio" 
                                                [(ngModel)]="selectedRadioValue"
                                                class="sr-only">
                                            <div [class]="'w-5 h-5 rounded-full border-2 transition-all duration-200 ' + 
                                                        (selectedRadioValue === 'forTable' ? 
                                                            'border-blue-500 bg-blue-500' : 
                                                            'border-gray-500 bg-transparent group-hover:border-blue-400')">
                                                <div *ngIf="selectedRadioValue === 'forTable'" class="w-2 h-2 bg-white rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
                                            </div>
                                        </div>
                                        <span class="ml-3 text-sm font-medium text-gray-300 group-hover:text-white transition-colors">
                                            <i class="fas fa-table mr-2 text-amber-400"></i>
                                            For Table
                                        </span>
                                    </label>
                                    <label class="flex items-center cursor-pointer group">
                                        <div class="relative">
                                            <input 
                                                id="forReservation" 
                                                type="radio" 
                                                (change)="onRadioChange($event)"
                                                value="forReservation" 
                                                name="default-radio" 
                                                [(ngModel)]="selectedRadioValue"
                                                class="sr-only">
                                            <div [class]="'w-5 h-5 rounded-full border-2 transition-all duration-200 ' + 
                                                        (selectedRadioValue === 'forReservation' ? 
                                                            'border-purple-500 bg-purple-500' : 
                                                            'border-gray-500 bg-transparent group-hover:border-purple-400')">
                                                <div *ngIf="selectedRadioValue === 'forReservation'" class="w-2 h-2 bg-white rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
                                            </div>
                                        </div>
                                        <span class="ml-3 text-sm font-medium text-gray-300 group-hover:text-white transition-colors">
                                            <i class="fas fa-bed mr-2 text-purple-400"></i>
                                            For Reservation
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <!-- Table Selection -->
                            <div *ngIf="selectedRadioValue == 'forTable'" id="table-selection" class="bg-gray-700 rounded-lg p-4 border border-gray-600 border-l-4 border-l-amber-500">
                                <label for="table-select" class="block text-sm font-semibold text-gray-200 mb-3 flex items-center gap-2">
                                    <i class="fas fa-table text-amber-400"></i>
                                    Select Table Number
                                </label>
                                <select 
                                    id="table-select" 
                                    [(ngModel)]="tableNumber"
                                    class="w-full bg-gray-600 border border-gray-500 text-gray-100 text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 p-3 transition-colors">
                                    <option value="" selected class="text-gray-400">Choose a table...</option>
                                    <option *ngFor="let table of allTables" [value]="table._id">
                                        Table {{table.tableNumber}}
                                    </option>
                                </select>
                            </div>

                            <!-- Reservation Selection -->
                            <div *ngIf="selectedRadioValue == 'forReservation'" id="reservation-selection" class="bg-gray-700 rounded-lg p-4 border border-gray-600 border-l-4 border-l-purple-500">
                                <label for="reservation-select" class="block text-sm font-semibold text-gray-200 mb-3 flex items-center gap-2">
                                    <i class="fas fa-bed text-purple-400"></i>
                                    Select Reservation
                                </label>
                                <select 
                                    id="reservation-select" 
                                    [(ngModel)]="reservationId"
                                    class="w-full bg-gray-600 border border-gray-500 text-gray-100 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 p-3 transition-colors">
                                    <option value="" selected class="text-gray-400">Choose a reservation...</option>
                                    <option *ngFor="let reservation of allReservations" [value]="reservation.id">
                                        {{reservation.customerFullName}} - Room [{{reservation.roomsAsString}}]
                                    </option>
                                </select>
                            </div>
                        </div>

                    </ng-container>
                    <!-- Enhanced Tab Buttons -->
                    <div id="tab-section" class="mt-6">
                        <div class="bg-gray-700 p-1 rounded-lg border border-gray-600">
                            <div class="flex gap-1">
                                <button 
                                    id="view-tab-btn"
                                    [disabled]="isButtonDisabled()" 
                                    (click)="loadOrder()" 
                                    [class]="'flex-1 py-3 px-4 text-sm font-medium text-center rounded-md transition-all duration-300 focus:outline-none flex items-center justify-center gap-2 ' + 
                                            (isView === true ? 
                                                'bg-blue-600 text-white shadow-lg ring-2 ring-blue-500 ring-opacity-50' : 
                                                'bg-transparent text-gray-300 hover:text-white hover:bg-gray-600'
                                            ) + 
                                            (isButtonDisabled() ? ' opacity-50 cursor-not-allowed' : '')">
                                    <i class="fas fa-eye text-xs"></i>
                                    <span>View Orders</span>
                                    <div *ngIf="isView === true" class="w-2 h-2 bg-blue-300 rounded-full animate-pulse"></div>
                                </button>
                                <button 
                                    id="order-tab-btn"
                                    [disabled]="isButtonDisabled()" 
                                    (click)="placeOrder()" 
                                    [class]="'flex-1 py-3 px-4 text-sm font-medium text-center rounded-md transition-all duration-300 focus:outline-none flex items-center justify-center gap-2 ' + 
                                            (isView === false ? 
                                                'bg-green-600 text-white shadow-lg ring-2 ring-green-500 ring-opacity-50' : 
                                                'bg-transparent text-gray-300 hover:text-white hover:bg-gray-600'
                                            ) + 
                                            (isButtonDisabled() ? ' opacity-50 cursor-not-allowed' : '')">
                                    <i class="fas fa-plus-circle text-xs"></i>
                                    <span>Place Order</span>
                                    <div *ngIf="isView === false" class="w-2 h-2 bg-green-300 rounded-full animate-pulse"></div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tab Indicator -->
                        <div class="mt-2 text-center">
                            <span class="text-xs text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                <span *ngIf="isView === true">Viewing existing orders</span>
                                <span *ngIf="isView === false">Adding new items to order</span>
                                <span *ngIf="isView === null || isView === undefined" class="text-amber-400">
                                    <i class="fas fa-arrow-up mr-1"></i>
                                    Select a mode to continue
                                </span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Order Items List -->
                <div id="order-items-section" class="flex-1 p-6">
                    
                    <!-- Edit Mode (New Orders) -->
                    <div *ngIf="isView === false" id="edit-order-mode">
                        <div class="bg-gray-700 rounded-lg h-64 overflow-y-auto border border-gray-600">
                            <div *ngFor="let order of orders; let i = index" id="order-item-edit-{{i}}" class="p-3 border-b border-gray-600 last:border-b-0">
                                <div class="grid grid-cols-3 gap-3 items-center">
                                    <div class="text-sm text-gray-200 truncate">{{order.name}}</div>
                                    <div class="flex items-center justify-center gap-2">
                                        <button 
                                            id="minus-qty-btn-{{i}}"
                                            (click)="minusMenuQty(order)" 
                                            class="w-7 h-7 bg-red-600 hover:bg-red-700 text-white rounded-full flex items-center justify-center transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                                            <i class="fas fa-minus text-xs"></i>
                                        </button>
                                        <input 
                                            id="qty-input-{{i}}"
                                            type="text" 
                                            readonly 
                                            [(ngModel)]="order.qty"
                                            class="w-12 text-center bg-gray-600 border border-gray-500 text-white text-sm rounded-md py-1 focus:ring-blue-500 focus:border-blue-500" />
                                        <button 
                                            id="plus-qty-btn-{{i}}"
                                            (click)="plusMenuQty(order)" 
                                            class="w-7 h-7 bg-green-600 hover:bg-green-700 text-white rounded-full flex items-center justify-center transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500">
                                            <i class="fas fa-plus text-xs"></i>
                                        </button>
                                    </div>
                                    <div class="text-sm text-blue-400 font-medium text-right">Rs. {{order.price}}</div>
                                </div>
                            </div>
                            <div *ngIf="orders.length === 0" id="empty-order-message" class="p-8 text-center text-gray-400">
                                <i class="fas fa-shopping-cart text-3xl mb-3"></i>
                                <p>No items in cart</p>
                            </div>
                        </div>
                    </div>

                    <!-- View Mode (Existing Orders) -->
                    <div *ngIf="isView === true" id="view-order-mode">
                        <div class="bg-gray-700 rounded-lg h-64 overflow-y-auto border border-gray-600">
                            <div *ngIf="orders.length > 0">
                                <div *ngFor="let order of orders; let i = index" id="order-item-view-{{i}}" class="p-3 border-b border-gray-600 last:border-b-0">
                                    <div class="grid grid-cols-4 gap-3 items-center">
                                        <div class="text-sm text-gray-200 truncate">{{order.name}}</div>
                                        <div class="flex justify-center">
                                            <input 
                                                id="view-qty-input-{{i}}"
                                                type="text" 
                                                readonly 
                                                [(ngModel)]="order.qty"
                                                class="w-12 text-center bg-gray-600 border border-gray-500 text-white text-sm rounded-md py-1" />
                                        </div>
                                        <div class="text-sm text-blue-400 font-medium text-center">Rs. {{order.price}}</div>
                                        <div class="flex justify-center">
                                            <button 
                                                id="cancel-order-btn-{{i}}"
                                                (click)="cancelOrder(order)" 
                                                type="button" 
                                                class="w-8 h-8 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center justify-center transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="orders.length === 0" id="empty-view-message" class="p-8 text-center text-gray-400">
                                <i class="fas fa-receipt text-3xl mb-3"></i>
                                <p>No orders found</p>
                            </div>
                        </div>
                    </div>

                    <!-- No Mode Selected State -->
                    <div *ngIf="isView === null || isView === undefined" id="no-mode-selected" class="bg-gray-700 rounded-lg h-64 border border-gray-600 border-dashed">
                        <div class="h-full flex items-center justify-center text-center text-gray-400">
                            <div class="space-y-4">
                                <div class="w-16 h-16 mx-auto bg-gray-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-hand-pointer text-2xl"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-300 mb-2">Choose Your Action</p>
                                    <p class="text-sm">Select "View Orders" to see existing orders</p>
                                    <p class="text-sm">or "Place Order" to add new items</p>
                                </div>
                                <div class="flex justify-center gap-2 text-xs">
                                    <span class="px-2 py-1 bg-blue-600 text-white rounded">View</span>
                                    <span class="text-gray-500">or</span>
                                    <span class="px-2 py-1 bg-green-600 text-white rounded">Order</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Section -->
                    <div id="order-total" class="mt-4 bg-gray-700 rounded-lg p-4 border border-gray-600">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-gray-200">Total</span>
                            <span class="text-xl font-bold text-blue-400">Rs. {{calculateOrderTotal()}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>