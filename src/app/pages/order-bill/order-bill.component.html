<app-notification *ngIf="showNotification" [notificationData]="notificationParams"></app-notification>
<app-loader *ngIf="isLoading"></app-loader>

<!-- Enhanced Checkout Modal -->
<div *ngIf="isCheckOutModalVisible" id="checkout-modal-overlay" tabindex="-1" aria-hidden="true"
    class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 transition-all duration-300">
    <div id="checkout-modal-container" class="p-4 w-full max-w-2xl max-h-full animate-fade-in">
        <!-- Modal content with enhanced styling -->
        <div id="checkout-modal-content" class="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl backdrop-blur-lg h-screen overflow-y-scroll" style="width: 600px;">
            <!-- Close button with better positioning -->
            <button id="modal-close-btn" (click)="closeCheckOutModal()" 
                class="absolute top-4 right-4 z-10 w-10 h-10 bg-red-600 hover:bg-red-700 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110 shadow-lg">
                <i class="fas fa-times text-white text-lg"></i>
            </button>

            <!-- Header with gradient -->
            <div id="modal-header" class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-t-2xl p-6">
                <!-- Enhanced Step Progress -->
                <div id="step-progress" class="w-full max-w-2xl">
                    <div class="flex justify-center mb-4">
                        <ng-container *ngFor="let step of steps; let i = index">
                            <div class="flex items-center">
                                <div id="step-circle-{{i}}" class="flex items-center justify-center w-12 h-12 rounded-full text-white font-bold text-sm border-2 transition-all duration-300 shadow-lg"
                                    [ngClass]="{'bg-gradient-to-r from-green-400 to-green-600 border-green-300 scale-110': currentStep >= i, 
                                               'bg-gray-600 border-gray-500': currentStep < i}">
                                    <i *ngIf="currentStep > i" class="fas fa-check"></i>
                                    <span *ngIf="currentStep <= i">{{ i + 1 }}</span>
                                </div>
                                <div *ngIf="i < steps.length - 1" id="step-connector-{{i}}" class="flex-1 h-2 mx-3 rounded-full transition-all duration-300"
                                    [ngClass]="{'bg-gradient-to-r from-green-400 to-green-600': currentStep > i, 
                                               'bg-gray-600': currentStep <= i}"></div>
                            </div>
                        </ng-container>
                    </div>
                    
                    <!-- Step Labels -->
                    <div class="flex justify-center text-white text-sm font-medium">
                        <div class="text-center" *ngFor="let step of ['Bill Details', 'Order Summary']; let i = index">
                            <span [ngClass]="{'text-green-300': currentStep >= i, 'text-gray-300': currentStep < i}">
                                {{ step }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Body -->
            <div id="modal-body" class="p-6">
                <ng-container [ngSwitch]="currentStep">
                    <!-- Step 1: Bill Info -->
                    <div *ngSwitchCase="0" id="bill-info-step">
                        <div id="bill-info-header" class="flex items-center justify-between mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-file-invoice-dollar text-blue-400 mr-3"></i>
                                Bill Information
                            </h3>
                        </div>

                        <div id="bill-form-grid" class="grid gap-6 grid-cols-2">
                            <!-- Customer Name -->
                            <div id="customer-name-field" class="col-span-2 md:col-span-1">
                                <label for="customer-name-input" class="block mb-2 text-sm font-medium text-gray-300">
                                    <i class="fas fa-user mr-2 text-blue-400"></i>Customer Name
                                </label>
                                <input id="customer-name-input" type="text"
                                    class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 placeholder-gray-400 transition-all duration-200 hover:border-gray-500"
                                    placeholder="Enter customer name"
                                    [(ngModel)]="this.selectedOrder.customerName" />
                            </div>

                            <!-- Payment Type -->
                            <div id="payment-type-field" class="col-span-2 md:col-span-1">
                                <label for="payment-type-select" class="block mb-2 text-sm font-medium text-gray-300">
                                    <i class="fas fa-credit-card mr-2 text-green-400"></i>Payment Type
                                </label>
                                <select id="payment-type-select" [(ngModel)]="this.selectedOrder.paymentType"
                                    class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition-all duration-200 hover:border-gray-500">
                                    <option value="0" class="bg-gray-800">💵 Cash</option>
                                    <option value="1" class="bg-gray-800">💳 Online</option>
                                </select>
                            </div>

                            <!-- Discount Type -->
                            <div id="discount-type-field" class="col-span-2 md:col-span-1">
                                <label for="discount-type-select" class="block mb-2 text-sm font-medium text-gray-300">
                                    <i class="fas fa-percent mr-2 text-yellow-400"></i>Discount Type
                                </label>
                                <select id="discount-type-select" [(ngModel)]="this.selectedOrder.discountType"
                                    class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition-all duration-200 hover:border-gray-500">
                                    <option value="0" class="bg-gray-800">📊 Percentage</option>
                                    <option value="1" class="bg-gray-800">💰 Fixed Amount</option>
                                </select>
                            </div>

                            <!-- Discount Percentage -->
                            <div *ngIf="this.selectedOrder.discountType == 0" id="discount-percent-field" class="col-span-2 md:col-span-1">
                                <label for="discount-percent-input" class="block mb-2 text-sm font-medium text-gray-300">
                                    <i class="fas fa-percentage mr-2 text-yellow-400"></i>Discount Percentage
                                </label>
                                <div class="relative">
                                    <input id="discount-percent-input" type="number"
                                        class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 pr-8 placeholder-gray-400 transition-all duration-200 hover:border-gray-500"
                                        placeholder="0" min="0" max="100"
                                        [(ngModel)]="this.selectedOrder.discountPercent" />
                                    <span class="absolute right-3 top-3 text-gray-400">%</span>
                                </div>
                            </div>

                            <!-- Discount Amount -->
                            <div *ngIf="this.selectedOrder.discountType == 1" id="discount-amount-field" class="col-span-2 md:col-span-1">
                                <label for="discount-amount-input" class="block mb-2 text-sm font-medium text-gray-300">
                                    <i class="fas fa-dollar-sign mr-2 text-yellow-400"></i>Discount Amount
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-400">$</span>
                                    <input id="discount-amount-input" type="number"
                                        class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 pl-8 placeholder-gray-400 transition-all duration-200 hover:border-gray-500"
                                        placeholder="0.00" min="0"
                                        [(ngModel)]="this.selectedOrder.discountAmt" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Bill Summary -->
                    <div *ngSwitchCase="1" id="bill-summary-step">
                        <div id="bill-summary-header" class="flex items-center justify-between mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-receipt text-green-400 mr-3"></i>
                                Order Summary
                            </h3>
                        </div>

                        <!-- Order Items Table -->
                        <div id="order-items-container" class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden mb-6">
                            <div class="max-h-64 overflow-y-auto custom-scrollbar">
                                <table id="order-items-table" class="w-full text-sm text-left text-gray-300">
                                    <thead class="text-xs text-gray-400 uppercase bg-gray-900 sticky top-0">
                                        <tr>
                                            <th scope="col" class="px-6 py-4">
                                                <i class="fas fa-utensils mr-2"></i>Item
                                            </th>
                                            <th scope="col" class="px-6 py-4 text-center">
                                                <i class="fas fa-sort-numeric-up mr-2"></i>Qty
                                            </th>
                                            <th scope="col" class="px-6 py-4 text-center">
                                                <i class="fas fa-tag mr-2"></i>Price
                                            </th>
                                            <th scope="col" class="px-6 py-4 text-center">
                                                <i class="fas fa-calculator mr-2"></i>Total
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="order-items-tbody">
                                        <tr *ngIf="selectedOrder.orders?.length === 0" class="h-32">
                                            <td colspan="4" class="text-center text-gray-500 py-8">
                                                <i class="fas fa-shopping-cart text-4xl mb-4 opacity-50"></i>
                                                <div>No items found</div>
                                            </td>
                                        </tr>
                                        <tr *ngFor="let order of selectedOrder.orders; let i = index" 
                                            id="order-item-{{i}}"
                                            class="bg-gray-800 border-b border-gray-700 hover:bg-gray-750 transition-colors duration-200">
                                            <td class="px-6 py-4 font-medium text-white">
                                                {{ order.name }}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="bg-blue-600 text-white px-2 py-1 rounded-full text-xs">
                                                    {{ order.qty }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center text-green-400">
                                                ${{ order.price }}
                                            </td>
                                            <td class="px-6 py-4 text-center font-medium text-white">
                                                ${{ order.price * order.qty }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Bill Totals -->
                        <div id="bill-totals" class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg p-6 border border-gray-700">
                            <div class="space-y-3">
                                <div id="subtotal-row" class="flex justify-between items-center text-gray-300">
                                    <span class="flex items-center">
                                        <i class="fas fa-list mr-2 text-blue-400"></i>Subtotal:
                                    </span>
                                    <span class="font-medium">${{ selectedOrder.subTotal }}</span>
                                </div>
                                <div id="discount-row" class="flex justify-between items-center text-gray-300">
                                    <span class="flex items-center">
                                        <i class="fas fa-percent mr-2 text-yellow-400"></i>Discount:
                                    </span>
                                    <span class="font-medium text-yellow-400">-${{ selectedOrder.discountAmt }}</span>
                                </div>
                                <div id="tax-row" class="flex justify-between items-center text-gray-300">
                                    <span class="flex items-center">
                                        <i class="fas fa-calculator mr-2 text-purple-400"></i>Tax:
                                    </span>
                                    <span class="font-medium">${{ selectedOrder.taxAmt }}</span>
                                </div>
                                <hr class="border-gray-600">
                                <div id="total-row" class="flex justify-between items-center text-lg font-bold text-white bg-green-600 bg-opacity-20 p-3 rounded-lg">
                                    <span class="flex items-center">
                                        <i class="fas fa-money-bill-wave mr-2 text-green-400"></i>Grand Total:
                                    </span>
                                    <span class="text-green-400">${{ selectedOrder.totalPayable }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>

            <!-- Enhanced Modal Footer -->
            <div id="modal-footer" class="flex justify-between items-center p-6 border-t border-gray-700 bg-gray-850 rounded-b-2xl">
                <button id="previous-btn" (click)="previousStep()" [disabled]="currentStep === 0"
                    class="flex items-center px-6 py-3 text-white bg-gray-600 hover:bg-gray-700 disabled:bg-gray-800 disabled:text-gray-500 font-medium rounded-lg text-sm transition-all duration-200 disabled:cursor-not-allowed">
                    <i class="fas fa-arrow-left mr-2"></i>Previous
                </button>
                
                <button id="next-btn" (click)="nextStep()" *ngIf="currentStep !== steps.length - 1"
                    class="flex items-center px-6 py-3 text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm transition-all duration-200 hover:shadow-lg">
                    Next<i class="fas fa-arrow-right ml-2"></i>
                </button>
                
                <button id="save-btn" (click)="checkOut()" *ngIf="currentStep === steps.length - 1"
                    class="flex items-center px-8 py-3 text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 font-medium rounded-lg text-sm transition-all duration-200 hover:shadow-lg hover:scale-105">
                    <i class="fas fa-save mr-2"></i>Save Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Main Content -->
<div id="main-container" class="flex-1 p-6 bg-gray-900 h-full min-h-screen">
    <!-- Header -->
    <div id="page-header" class="flex items-center justify-between mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700 shadow-lg">
        <div class="flex items-center">
            <div class="bg-blue-600 p-3 rounded-lg mr-4">
                <i class="fas fa-file-invoice text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white">Bill Management</h1>
                <p class="text-gray-400 text-sm">Manage orders and generate invoices</p>
            </div>
        </div>
    </div>

    <hr id="header-divider" class="h-px my-4 bg-gradient-to-r from-transparent via-gray-600 to-transparent border-0">

    <!-- Enhanced Filters -->
    <div id="filters-container" class="flex items-center justify-end mb-6">
        <div id="filters-wrapper" class="flex items-center space-x-3 bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg">
            <!-- Status Filter -->
            <div id="status-filter" class="relative">
                <label for="status-select" class="sr-only">Status Filter</label>
                <select id="status-select" [(ngModel)]="filter.status"
                    class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-3 pr-8 hover:bg-gray-650 transition-all duration-200 min-w-32">
                    <option value="" class="bg-gray-700" selected>🔍 All Status</option>
                    <option *ngFor="let status of orderStatus" [value]="status.key" class="bg-gray-700">
                        {{ status.value }}
                    </option>
                </select>
            </div>

            <!-- Table Filter -->
            <div id="table-filter" class="relative">
                <label for="table-select" class="sr-only">Table Filter</label>
                <select id="table-select" [(ngModel)]="filter.tableNumber"
                    class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-3 pr-8 hover:bg-gray-650 transition-all duration-200 min-w-32">
                    <option value="" class="bg-gray-700" selected>🪑 All Tables</option>
                    <option *ngFor="let table of tableNumbers" [value]="table._id" class="bg-gray-700">
                        Table {{ table.tableNumber }}
                    </option>
                </select>
            </div>

            <!-- Search -->
            <div id="search-filter" class="relative">
                <app-autocomplete [searchControl]="searchControl" [filteredOptions]="filteredOptions" (callback)="updateFilterOptions($event)"></app-autocomplete>
            </div>

            <!-- Action Buttons -->
            <button id="apply-filter-btn" type="button" (click)="searchButtonClicked()"
                class="flex items-center px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all duration-200 hover:shadow-lg">
                <i class="fas fa-search mr-2"></i>Apply
            </button>
            
            <button id="clear-filter-btn" type="button" (click)="clearFilter()"
                class="flex items-center px-4 py-3 text-sm font-medium text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-all duration-200 hover:shadow-lg">
                <i class="fas fa-eraser mr-2"></i>Clear
            </button>
        </div>
    </div>

    <!-- Enhanced Data Table -->
    <div id="data-table-container" class="bg-gray-800 rounded-lg border border-gray-700 shadow-xl overflow-hidden">
        <div class="overflow-x-auto" style="max-height: 500px;">
            <table id="orders-table" class="w-full text-sm text-left text-gray-300">
                <thead id="table-header" class="text-xs text-gray-400 uppercase bg-gray-900 sticky top-0 z-10">
                    <tr>
                        <th id="checkbox-header" scope="col" class="p-4 border-b border-gray-700">
                            <div class="flex items-center">
                                <input id="checkbox-all" type="checkbox" 
                                    class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2">
                                <label for="checkbox-all" class="sr-only">Select all</label>
                            </div>
                        </th>
                        <th id="table-number-header" scope="col" class="px-6 py-4 border-b border-gray-700">
                            <div class="flex items-center">
                                <i class="fas fa-chair mr-2 text-blue-400"></i>Table
                            </div>
                        </th>
                        <th id="customer-header" scope="col" class="px-6 py-4 border-b border-gray-700">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-2 text-green-400"></i>Customer
                            </div>
                        </th>
                        <th id="status-header" scope="col" class="px-6 py-4 border-b border-gray-700">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle mr-2 text-yellow-400"></i>Status
                            </div>
                        </th>
                        <th id="total-header" scope="col" class="px-6 py-4 border-b border-gray-700">
                            <div class="flex items-center">
                                <i class="fas fa-dollar-sign mr-2 text-purple-400"></i>Total
                            </div>
                        </th>
                        <th id="action-header" scope="col" class="px-6 py-4 border-b border-gray-700">
                            <div class="flex items-center">
                                <i class="fas fa-cogs mr-2 text-red-400"></i>Actions
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="orders-tbody">
                    <tr *ngIf="orders.length === 0" id="no-records-row" class="h-40">
                        <td colspan="6" class="text-center py-12">
                            <div class="flex flex-col items-center text-gray-500">
                                <i class="fas fa-inbox text-6xl mb-4 opacity-30"></i>
                                <p class="text-xl font-medium">No orders found</p>
                                <p class="text-sm">Try adjusting your filters</p>
                            </div>
                        </td>
                    </tr>
                    <tr *ngFor="let order of orders; let i = index" 
                        id="order-row-{{order.id}}"
                        class="bg-gray-800 border-b border-gray-700 hover:bg-gray-750 transition-all duration-200 hover:shadow-lg">
                        <td id="checkbox-cell-{{order.id}}" class="w-4 p-4">
                            <div class="flex items-center">
                                <input id="checkbox-order-{{order.id}}" type="checkbox"
                                    class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2">
                                <label for="checkbox-order-{{order.id}}" class="sr-only">Select order</label>
                            </div>
                        </td>
                        <td id="table-cell-{{order.id}}" class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium">
                                    {{ order.table.tableNumber }}
                                </div>
                            </div>
                        </td>
                        <td id="customer-cell-{{order.id}}" class="px-6 py-4">
                            <div class="flex items-center">
                                <i class="fas fa-user-circle text-gray-400 mr-2"></i>
                                <span class="font-medium text-white">{{ order.customerName ?? "Walk-in Customer" }}</span>
                            </div>
                        </td>
                        <td id="status-cell-{{order.id}}" class="px-6 py-4">
                            <div class="flex items-center">
                                <span class="px-3 py-1 rounded-full text-xs font-medium"
                                    [ngClass]="{
                                        'bg-yellow-900 text-yellow-300 border border-yellow-600': order.status === 0,
                                        'bg-blue-900 text-blue-300 border border-blue-600': order.status === 1,
                                        'bg-orange-900 text-orange-300 border border-orange-600': order.status === 2,
                                        'bg-green-900 text-green-300 border border-green-600': order.status === 3
                                    }">
                                    {{ getOrderStatus(order.status) }}
                                </span>
                            </div>
                        </td>
                        <td id="total-cell-{{order.id}}" class="px-6 py-4">
                            <div class="flex items-center font-bold text-green-400 text-lg">
                                ${{ order.total }}
                            </div>
                        </td>
                        <td id="action-cell-{{order.id}}" class="px-6 py-4">
                            <button *ngIf="order.status != 3" 
                                id="pay-now-btn-{{order.id}}" 
                                type="button" 
                                (click)="payNow(order)"
                                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 hover:shadow-lg hover:scale-105">
                                <i class="fas fa-credit-card mr-2"></i>Pay Now
                            </button>
                            <button *ngIf="order.status == 3" 
                                id="invoice-btn-{{order.id}}" 
                                type="button" 
                                (click)="checkOutAndPrintInvoice(order)"
                                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-green-500 to-green-600 rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 hover:shadow-lg hover:scale-105">
                                <i class="fas fa-file-pdf mr-2"></i>Invoice
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Enhanced Pagination -->
    <div id="pagination-container" class="mt-6">
        <app-pagination [dataCount]="filter.pagination.dataCount" 
                       [page]="filter.pagination.page"
                       [pageSize]="filter.pagination.pageSize" 
                       (callback)="updatePaginationPage($event)">
        </app-pagination>
    </div>
</div>

<!-- Add custom CSS for enhanced styling -->
<style>
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #6B7280;
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
    }
    
    .bg-gray-750 {
        background-color: #3f4147;
    }
    
    .bg-gray-650 {
        background-color: #4a5166;
    }
    
    .bg-gray-850 {
        background-color: #1f2937;
    }
    
    /* Hover effects */
    .hover\:scale-105:hover {
        transform: scale(1.05);
    }
    
    /* Focus styles for better accessibility */
    .focus\:ring-blue-500:focus {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
</style>